
/**诺诺金服前端团队
 *创建于2018-8-3 11:7:16
 * Released under the MIT License.
*/
(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
    typeof define === 'function' && define.amd ? define(factory) :
    (global.Ec = factory());
}(this, (function () {
    var date = new Date();
    var timeStr = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + " " + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();

    function initGetDomTarget() {
        //初始化获取触发错误的dom元素
        this.target = null;
        this.triggerStartTime = 0;
        this.triggerEndTime = 0;
        this.targetClass = '';
        this.targetId = '';
        bindEvent.call(this);
    }

    function bindEvent() {
        var _this = this;

        window.addEventListener('click', function (e) {
            e = e || window.event;
            _this.target = e.target || e.srcElement;
            _this.targetId = e.target.id;
            _this.targetClass = e.target.className;
            _this.triggerEndTime = new Date().getTime();
        }, false);
    }

    function createTargetStr() {
        //创建字符串格式的html元素
        var str = '<';
        str += this.target.tagName.toLowerCase();
        if (this.targetClass) {
            str += ' class="' + this.targetClass + '"';
        }
        if (this.targetId) {
            str += ' id="' + this.targetId + '"';
        }
        str += '>\u2026\u2026';
        this.target = null; //生成触发dom元素str后，清除ec实例的目标元素属性
        return str;
    }

    function initEc(Ec) {
    	//初始化这个类
    	Ec.prototype.init = function (cb) {
    		this.ecData = {
    			errorMesg: '', //错误信息
    			errorTip: '', //针对错误信息，做出的人性化提示
    			errorFile: '', //错误文件路径名称
    			errorLine: '', //错误代码行
    			errorColum: '', //错误代码列
    			userAgent: {//用户代理信息

    			},
    			errorTime: '', //发生错误的事件
    			userLocation: '', //发生错误所处地点
    			domTarget: '' //触发错误的dom元素
    		};
    		this.cb = cb;
    		bindGlobalErrorEvent.call(this);
    		initGetDomTarget.call(this);
    	};
    }

    function bindGlobalErrorEvent() {
    	var _this = this;

    	//给window绑定错误事件处理程序
    	window.addEventListener('error', function (e) {
    		//如果页面触发了错误
    		e = e || window.event;
    		//获取这些错误信息
    		_this.ecData.errorMesg = e.message;
    		_this.ecData.errorFile = e.filename;
    		_this.ecData.errorLine = e.lineno;
    		_this.ecData.errorColum = e.colno;
    		_this.ecData.errorTime = timeStr;
    		setTimeout(function () {
    			if (_this.target) {
    				//如果ec实例有错误触发目标，那么生成对应的dom字符串，供传给后台保存，以便清晰记录准确定位
    				_this.ecData.domTarget = createTargetStr.call(_this);
    			}
    			//执行初始化时用户传入的回调函数，在该函数中执行对错误信息的上报操作
    			_this.cb(_this.ecData);
    		}, 0);
    	}, false);
    }

    function Ec(cb) {
    	this.init(cb);
    }
    initEc(Ec);

    return Ec;

})));
//# sourceMappingURL=ec.min.js.map
